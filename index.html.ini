<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®—æ•°ãƒã‚¹ã‚¿ãƒ¼ï¼šé•·ã•ã®è¨ˆç®—ã¨ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&display=swap');
        
        body {
            font-family: 'Kiwi Maru', serif;
            background-color: #fdf2f8;
            touch-action: manipulation;
            overflow-x: hidden;
        }

        .ruler {
            background: linear-gradient(to bottom, #fffde7 0%, #fff9c4 100%);
            border: 2px solid #fbc02d;
            position: relative;
            height: 100px;
        }

        .tick {
            position: absolute;
            bottom: 0;
            width: 1px;
            background-color: #333;
        }

        .tick-mm { height: 15px; }
        .tick-half { height: 25px; width: 2px; }
        .tick-cm { height: 40px; width: 2px; }

        .btn-bounce:active {
            transform: scale(0.9);
        }

        @keyframes popUp {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .animal-pop {
            animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .confetti {
            position: fixed;
            pointer-events: none;
            z-index: 100;
            animation: fall 2s linear forwards;
        }

        @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-2xl mx-auto bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-8 border-pink-200">
        <!-- Header with Level Info -->
        <header class="bg-gradient-to-r from-pink-400 to-orange-400 p-6 text-white shadow-md relative">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-2xl font-bold">ğŸ‘‘ ã•ã‚“ã™ã†ã‚¯ã‚¨ã‚¹ãƒˆ</h1>
                <div class="text-right">
                    <div class="text-xs font-bold opacity-90" id="rank-display">ãªãŒã•ã® ãŸã¾ã”</div>
                    <div class="text-xl font-black">Lv.<span id="level-display">1</span></div>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="w-full bg-pink-900/20 h-4 rounded-full overflow-hidden border border-white/30">
                <div id="exp-bar" class="progress-bar-fill bg-yellow-300 h-full w-[0%]"></div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-6 relative">
            <!-- Animal Toast Container -->
            <div id="animal-toast" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-white/90 backdrop-blur-sm pointer-events-none">
                <div id="animal-emoji" class="text-9xl mb-4">ğŸ¶</div>
                <div id="animal-msg" class="text-3xl font-bold text-pink-600 text-center">ã™ã”ã„ï¼ï¼</div>
                <div id="level-up-text" class="hidden mt-4 text-4xl font-black text-yellow-500 italic animate-bounce">LEVEL UP!</div>
            </div>

            <!-- Menu Screen -->
            <div id="menu-screen" class="space-y-6">
                <div class="text-center py-2">
                    <p class="text-gray-500 font-bold mb-1">ã¤ãã®ãƒ¬ãƒ™ãƒ«ã¾ã§ ã‚ã¨ <span id="next-exp" class="text-pink-500">10</span> EXP</p>
                    <div class="flex justify-center gap-2 text-2xl">ğŸ¦ğŸ°ğŸ¼ğŸ˜ğŸ¦Š</div>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <!-- New Mix Mode Button -->
                    <button onclick="startGame('mix')" class="w-full bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 text-white font-black py-5 rounded-2xl text-xl shadow-lg btn-bounce border-b-4 border-indigo-700 transition-transform animate-pulse">
                        ğŸŒˆ ã”ã¡ã‚ƒã¾ãœãƒŸãƒƒã‚¯ã‚¹ï¼
                    </button>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="startGame('fun')" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-4 rounded-2xl text-lg shadow-md btn-bounce border-b-4 border-yellow-600">
                            ğŸ¾ ã„ãã‚‚ã®
                        </button>
                        <button onclick="startGame('convert')" class="bg-orange-400 hover:bg-orange-500 text-white font-bold py-4 rounded-2xl text-lg shadow-md btn-bounce border-b-4 border-orange-600">
                            ğŸ”„ ãŸã‚“ã„
                        </button>
                        <button onclick="startGame('measure')" class="bg-purple-400 hover:bg-purple-500 text-white font-bold py-4 rounded-2xl text-lg shadow-md btn-bounce border-b-4 border-purple-600">
                            ğŸ” ã‚‚ã®ã•ã—
                        </button>
                        <button onclick="startGame('unit-plus')" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl text-lg shadow-md btn-bounce border-b-4 border-blue-600">
                            â• ãŸã—ã–ã‚“
                        </button>
                        <button onclick="startGame('unit-minus')" class="col-span-2 bg-red-400 hover:bg-red-500 text-white font-bold py-4 rounded-2xl text-lg shadow-md btn-bounce border-b-4 border-red-600">
                            â– ã²ãã–ã‚“
                        </button>
                    </div>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="game-screen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="showMenu()" class="bg-gray-100 px-4 py-2 rounded-full text-gray-600 font-bold hover:bg-gray-200">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
                    <div class="flex items-center gap-3">
                        <div class="text-pink-500 font-bold text-sm">EXP +10</div>
                        <div class="bg-yellow-100 px-6 py-2 rounded-full text-yellow-700 font-extrabold text-xl shadow-inner">
                            â­ <span id="score">0</span>
                        </div>
                    </div>
                </div>

                <div id="question-container" class="text-center py-6 min-h-[140px] flex flex-col justify-center items-center"></div>
                
                <div id="answer-container" class="grid grid-cols-2 gap-4"></div>
                
                <!-- Feedback & Explanation Area -->
                <div id="feedback-area" class="hidden mt-6 p-4 bg-blue-50 border-4 border-blue-200 rounded-2xl text-center">
                    <div id="feedback-text" class="text-2xl font-bold mb-2"></div>
                    <div id="explanation-text" class="text-lg text-gray-700 font-medium mb-4 whitespace-pre-wrap"></div>
                    <button onclick="nextQuestion()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg btn-bounce text-xl">
                        ã¤ãã¸ ã™ã™ã‚€ ğŸš€
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Game State
        let level = 1;
        let exp = 0;
        let score = 0;
        let currentMode = ''; // 'mix', 'fun', 'convert', etc.
        let activeMode = ''; // The actual mode being played for the current question
        let correctAnswer = null;
        let currentExplanation = "";

        const ranks = [
            { lv: 1, title: "ãªãŒã•ã® ãŸã¾ã”" },
            { lv: 3, title: "ãŸã‚“ã„ ã¿ãªã‚‰ã„" },
            { lv: 5, title: "ã‚‚ã®ã•ã— ã¤ã‹ã„" },
            { lv: 8, title: "ã•ã‚“ã™ã† ãã—" },
            { lv: 12, title: "ãªãŒã•ã® ã¾ã˜ã‚…ã¤ã—" },
            { lv: 20, title: "ã•ã‚“ã™ã† ã‚­ãƒ³ã‚°" }
        ];

        const animals = [
            { emoji: 'ğŸ¶', name: 'ã„ã¬' }, { emoji: 'ğŸ±', name: 'ã­ã“' },
            { emoji: 'ğŸ°', name: 'ã†ã•ã' }, { emoji: 'ğŸ¼', name: 'ã±ã‚“ã ' },
            { emoji: 'ğŸ¦', name: 'ã‚‰ã„ãŠã‚“' }, { emoji: 'ğŸ˜', name: 'ãã†' },
            { emoji: 'ğŸ¹', name: 'ã¯ã‚€ã™ãŸãƒ¼' }, { emoji: 'ğŸ¦Š', name: 'ãã¤ã­' },
            { emoji: 'ğŸ¨', name: 'ã“ã‚ã‚‰' }, { emoji: 'ğŸ¯', name: 'ã¨ã‚‰' }
        ];

        const funQuestions = [
            { q: "ãƒ€ãƒƒã‚¯ã‚¹ãƒ•ãƒ³ãƒˆã® ã‹ã‚‰ã ã® ãªãŒã•ã¯ ã©ã‚Œãã‚‰ã„ï¼Ÿ", a: "60cm", hint: "ğŸ•", expl: "ãƒ€ãƒƒã‚¯ã‚¹ãƒ•ãƒ³ãƒˆã¯ã€ãƒãƒ¼ãƒˆã‚’2ã•ã¤ ã¤ãªã’ãŸãã‚‰ã„ã® ãªãŒã•ã ã‚ˆï¼", opts: ["6cm", "60cm", "6m", "60m"] },
            { q: "å¤§ããª ãƒãƒŠãƒŠã® ãªãŒã•ã¯ ã©ã‚Œãã‚‰ã„ï¼Ÿ", a: "20cm", hint: "ğŸŒ", expl: "ãƒãƒŠãƒŠã¯ã€ã ã„ãŸã„ã€Œ30ã‚»ãƒ³ãƒã‚‚ã®ã•ã—ã€ã‚ˆã‚Š ã¡ã‚‡ã£ã¨çŸ­ã„ãã‚‰ã„ã ã­ã€‚", opts: ["2cm", "20cm", "2m", "20mm"] },
            { q: "ã¿ã‚“ãªãŒã¤ã‹ã† ãˆã‚“ã´ã¤ã® ãªãŒã•ã¯ ã©ã‚Œãã‚‰ã„ï¼Ÿ", a: "18cm", hint: "âœï¸", expl: "ãŠã‚ã—ãŸã¦ã® ãˆã‚“ã´ã¤ã¯ã€ã ã„ãŸã„ 18ã‚»ãƒ³ãƒãã‚‰ã„ã ã‚ˆã€‚", opts: ["18mm", "18cm", "1m", "18m"] },
            { q: "ä¸€å††ç‰ï¼ˆã„ã¡ãˆã‚“ã ã¾ï¼‰ã® ã¯ã°ã¯ ã©ã‚Œãã‚‰ã„ï¼Ÿ", a: "2cm", hint: "ğŸª™", expl: "1å††ç‰ã¯ ã´ã£ãŸã‚Š 20ãƒŸãƒªï¼ˆ2ã‚»ãƒ³ãƒï¼‰ãªã‚“ã ã‚ˆï¼", opts: ["2mm", "2cm", "20cm", "2m"] },
            { q: "å¤§äººã® ã†ã§ã©ã‘ã„ã® ã¯ã°ã¯ ã©ã‚Œãã‚‰ã„ï¼Ÿ", a: "4cm", hint: "âŒš", expl: "æ™‚è¨ˆã® ã¾ã‚‹ã„éƒ¨åˆ†ã¯ã€ã ã„ãŸã„ 4ã‚»ãƒ³ãƒãã‚‰ã„ã ã­ã€‚", opts: ["4mm", "4cm", "40cm", "4m"] },
            { q: "ã‚­ãƒªãƒ³ã•ã‚“ã® ãªãŒã„é¦–ï¼ˆãã³ï¼‰ã® ãªãŒã•ã¯ï¼Ÿ", a: "2m", hint: "ğŸ¦’", expl: "ã‚­ãƒªãƒ³ã•ã‚“ã®é¦–ã¯ã€å¤§äººã‚ˆã‚Šã‚‚ ãšã£ã¨ ãªãŒã„ã‚“ã ï¼", opts: ["20cm", "2m", "20m", "200m"] },
            { q: "ã¯ãŒãã® ãŸã¦ã® ãªãŒã•ã¯ ã©ã‚Œãã‚‰ã„ï¼Ÿ", a: "15cm", hint: "ğŸ“®", expl: "ã¯ãŒãã¯ã€15ã‚»ãƒ³ãƒã‚‚ã®ã•ã—ã¨ ã»ã¨ã‚“ã© ãŠãªã˜é•·ã•ã ã‚ˆã€‚", opts: ["15mm", "15cm", "1m 50cm", "15m"] },
            { q: "ã‚µãƒƒã‚«ãƒ¼ã‚´ãƒ¼ãƒ«ã® ã‚ˆã“ã® ãªãŒã•ã¯ ã©ã‚Œãã‚‰ã„ï¼Ÿ", a: "7m", hint: "âš½", expl: "ã‚µãƒƒã‚«ãƒ¼ã®ã‚´ãƒ¼ãƒ«ã¯ ã¨ã£ã¦ã‚‚å¤§ãã„ã‚ˆã€‚7ãƒ¡ãƒ¼ãƒˆãƒ«ã‚‚ã‚ã‚‹ã‚“ã ï¼", opts: ["70cm", "7m", "70m", "700m"] },
            { q: "æ•™ç§‘æ›¸ï¼ˆãã‚‡ã†ã‹ã—ã‚‡ï¼‰ã® ã‚ã¤ã¿ã¯ ã©ã‚Œãã‚‰ã„ï¼Ÿ", a: "1cm", hint: "ğŸ“š", expl: "æ•™ç§‘æ›¸ã®ã€Œã‚ã¤ã•ã€ã¯ã€ã ã„ãŸã„ 1ã‚»ãƒ³ãƒï¼ˆ10ãƒŸãƒªï¼‰ãã‚‰ã„ã ã­ã€‚", opts: ["1mm", "1cm", "10cm", "1m"] },
            { q: "ã‚¢ãƒªã•ã‚“ã® ã‹ã‚‰ã ã® ãªãŒã•ã¯ ã©ã‚Œãã‚‰ã„ï¼Ÿ", a: "5mm", hint: "ğŸœ", expl: "ã‚¢ãƒªã•ã‚“ã¯ ã¨ã£ã¦ã‚‚å°ã•ã„ã­ã€‚1ã‚»ãƒ³ãƒã® ã¯ã‚“ã¶ã‚“ãã‚‰ã„ã ã‚ˆã€‚", opts: ["5mm", "5cm", "50cm", "5m"] }
        ];

        const praiseMessages = [
            "ã™ã”ã„ï¼ã¦ã‚“ã•ã„ï¼", "ãã®ã¡ã‚‡ã†ã—ï¼", "ã ã„ã›ã„ã‹ã„ï¼",
            "ã‹ã£ã“ã„ã„ï¼", "ã‚„ã‚‹ã­ï¼", "ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼", "ãã¿ã¯ ã™ã”ã„ã‚ˆï¼"
        ];

        const elements = {
            menu: document.getElementById('menu-screen'),
            game: document.getElementById('game-screen'),
            qContainer: document.getElementById('question-container'),
            aContainer: document.getElementById('answer-container'),
            score: document.getElementById('score'),
            level: document.getElementById('level-display'),
            rank: document.getElementById('rank-display'),
            expBar: document.getElementById('exp-bar'),
            nextExp: document.getElementById('next-exp'),
            toast: document.getElementById('animal-toast'),
            toastEmoji: document.getElementById('animal-emoji'),
            toastMsg: document.getElementById('animal-msg'),
            lvUpText: document.getElementById('level-up-text'),
            feedbackArea: document.getElementById('feedback-area'),
            feedbackText: document.getElementById('feedback-text'),
            explanationText: document.getElementById('explanation-text')
        };

        function updateLevelUI() {
            const expPerLevel = 50;
            const currentLevelExp = exp % expPerLevel;
            const progress = (currentLevelExp / expPerLevel) * 100;
            
            elements.level.innerText = level;
            elements.expBar.style.width = progress + '%';
            elements.nextExp.innerText = expPerLevel - currentLevelExp;
            
            let currentRank = ranks[0].title;
            for(let r of ranks) {
                if(level >= r.lv) currentRank = r.title;
            }
            elements.rank.innerText = currentRank;
        }

        function showMenu() {
            elements.menu.classList.remove('hidden');
            elements.game.classList.add('hidden');
            updateLevelUI();
        }

        function startGame(mode) {
            currentMode = mode;
            score = 0;
            elements.score.innerText = score;
            elements.menu.classList.add('hidden');
            elements.game.classList.remove('hidden');
            nextQuestion();
        }

        function nextQuestion() {
            elements.toast.classList.add('hidden');
            elements.lvUpText.classList.add('hidden');
            elements.feedbackArea.classList.add('hidden');
            elements.aContainer.classList.remove('hidden');
            elements.qContainer.innerHTML = '';
            elements.aContainer.innerHTML = '';
            
            // Determine which mode to use for this specific question
            if (currentMode === 'mix') {
                const modes = ['fun', 'convert', 'measure', 'unit-plus', 'unit-minus'];
                activeMode = modes[Math.floor(Math.random() * modes.length)];
            } else {
                activeMode = currentMode;
            }

            if (activeMode === 'fun') generateFun();
            else if (activeMode === 'convert') generateConvert();
            else if (activeMode === 'measure') generateMeasure();
            else if (activeMode.startsWith('unit')) generateUnitMath();
        }

        function addExp(amount) {
            const oldLevel = level;
            exp += amount;
            level = Math.floor(exp / 50) + 1;
            return level > oldLevel;
        }

        function showResult(isCorrect) {
            if (isCorrect) {
                score += 10;
                elements.score.innerText = score;
                const leveledUp = addExp(10);
                updateLevelUI();

                const animal = animals[Math.floor(Math.random() * animals.length)];
                elements.toastEmoji.innerText = animal.emoji;
                elements.toastMsg.innerText = praiseMessages[Math.floor(Math.random() * praiseMessages.length)];
                
                if (leveledUp) {
                    elements.lvUpText.classList.remove('hidden');
                    elements.toastMsg.innerText = "ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ ãŠã‚ã§ã¨ã†ï¼";
                }

                elements.toast.classList.remove('hidden');
                elements.toast.classList.add('animal-pop');
                createConfetti(leveledUp ? 30 : 15);

                setTimeout(() => {
                    elements.toast.classList.remove('animal-pop');
                    nextQuestion();
                }, leveledUp ? 2500 : 1500);
            } else {
                elements.aContainer.classList.add('hidden');
                elements.feedbackArea.classList.remove('hidden');
                elements.feedbackText.innerText = "âŒ ã–ã‚“ã­ã‚“ï¼ ãŠã—ã„ï¼";
                elements.feedbackText.className = "text-2xl font-bold mb-2 text-gray-500";
                elements.explanationText.innerText = currentExplanation + "\n\nã›ã„ã‹ã„ã¯ ã€Œ" + correctAnswer + "ã€ ã ã‚ˆï¼";
            }
        }

        function createConfetti(count) {
            const emojis = ['âœ¨', 'ğŸŒŸ', 'ğŸˆ', 'ğŸ’–', 'ğŸ€', 'ğŸŒ¸', 'ğŸ¥‡'];
            for(let i=0; i<count; i++) {
                const el = document.createElement('div');
                el.className = 'confetti text-2xl';
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.style.left = Math.random() * 100 + 'vw';
                el.style.top = '-20px';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 2000);
            }
        }

        // --- Question Generators ---

        function generateFun() {
            const q = funQuestions[Math.floor(Math.random() * funQuestions.length)];
            correctAnswer = q.a;
            currentExplanation = q.expl;
            elements.qContainer.innerHTML = `
                <div class="bg-yellow-50 px-4 py-1 rounded-full text-yellow-600 font-bold text-sm mb-2">ğŸ¾ ã„ãã‚‚ã®ã‚¯ã‚¤ã‚º</div>
                <div class="text-6xl mb-4">${q.hint}</div>
                <div class="text-2xl font-bold text-yellow-600 px-4">${q.q}</div>
            `;
            q.opts.forEach(o => {
                const b = document.createElement('button');
                b.className = "bg-white border-4 border-gray-100 py-4 rounded-2xl text-xl font-bold shadow-md btn-bounce hover:border-yellow-300 transition-colors";
                b.innerText = o;
                b.onclick = () => showResult(o === correctAnswer);
                elements.aContainer.appendChild(b);
            });
        }

        function generateUnitMath() {
            const subType = Math.floor(Math.random() * 4);
            let display, ans, expl;
            const isPlus = activeMode === 'unit-plus';
            const op = isPlus ? 'ï¼‹' : 'ï¼';

            if (subType === 0) { // Same unit
                const unit = Math.random() > 0.5 ? 'cm' : 'mm';
                const n1 = Math.floor(Math.random() * 20) + 10;
                const n2 = Math.floor(Math.random() * (isPlus ? 15 : n1 - 1)) + 1;
                ans = isPlus ? (n1 + n2) + unit : (n1 - n2) + unit;
                display = `${n1}${unit} ${op} ${n2}${unit} ï¼ ï¼Ÿ`;
                expl = `ãŠãªã˜ ãŸã‚“ã„ï¼ˆ${unit}ï¼‰ã©ã†ã—ã‚’ ãã®ã¾ã¾ ${isPlus ? 'ãŸã›ã°' : 'ã²ã‘ã°'} ã„ã„ã‚“ã ã‚ˆã€‚`;
            } else if (subType === 1) { // m only
                const n1 = Math.floor(Math.random() * 10) + 5;
                const n2 = Math.floor(Math.random() * (isPlus ? 10 : n1 - 1)) + 1;
                ans = isPlus ? (n1 + n2) + "m" : (n1 - n2) + "m";
                display = `${n1}m ${op} ${n2}m ï¼ ï¼Ÿ`;
                expl = `ãƒ¡ãƒ¼ãƒˆãƒ«ï¼ˆmï¼‰ã©ã†ã—ã® ${isPlus ? 'ãŸã—ã–ã‚“' : 'ã²ãã–ã‚“'} ã‚‚ã€æ•°å­—ã‚’ã¿ã‚Œã° ã‹ã‚“ãŸã‚“ã ã­ï¼`;
            } else if (subType === 2) { // m and cm
                let m = Math.floor(Math.random() * 5) + 1;
                let cm = Math.floor(Math.random() * 40) + 10;
                let cm2 = Math.floor(Math.random() * (isPlus ? (80-cm) : cm - 5)) + 5;
                if (isPlus) ans = `${m}m ${cm + cm2}cm`;
                else ans = `${m}m ${cm - cm2}cm`;
                display = `${m}m ${cm}cm ${op} ${cm2}cm ï¼ ï¼Ÿ`;
                expl = `cmï¼ˆã‚»ãƒ³ãƒï¼‰ã®ã¨ã“ã‚ã ã‘ ${isPlus ? 'ãŸã›ã°' : 'ã²ã‘ã°'} ã„ã„ã‚“ã ã‚ˆã€‚mï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰ã¯ãã®ã¾ã¾ã ã­ã€‚`;
            } else { // cm mm mix
                let cm = Math.floor(Math.random() * 8) + 1;
                let mm = Math.floor(Math.random() * 8) + 1;
                let mm2 = Math.floor(Math.random() * (isPlus ? (9-mm) : mm - 1)) + 1;
                if (isPlus) ans = `${cm}cm ${mm + mm2}mm`;
                else ans = `${cm}cm ${mm - mm2}mm`;
                display = `${cm}cm ${mm}mm ${op} ${mm2}mm ï¼ ï¼Ÿ`;
                expl = `mmï¼ˆãƒŸãƒªï¼‰ã®ã¨ã“ã‚ã ã‘ ${isPlus ? 'ãŸã›ã°' : 'ã²ã‘ã°'} æ­£è§£ã ã‚ˆï¼`;
            }

            correctAnswer = ans;
            currentExplanation = expl;
            elements.qContainer.innerHTML = `
                <div class="${isPlus ? 'bg-blue-50 text-blue-600' : 'bg-red-50 text-red-600'} px-4 py-1 rounded-full font-bold text-sm mb-4">${isPlus ? 'â• ãŸã—ã–ã‚“' : 'â– ã²ãã–ã‚“'}</div>
                <div class="text-3xl font-bold text-gray-800">${display}</div>
            `;
            setupOptions(correctAnswer);
        }

        function generateConvert() {
            const types = [
                { from: 'cm', to: 'mm', m: 10, expl: '1cm ã¯ 10mm ã ã‚ˆã€‚10ã‚’ ã‹ã‘ã‚Œã°ã„ã„ã‚“ã ã­ï¼' },
                { from: 'm', to: 'cm', m: 100, expl: '1m ã¯ 100cm ã ã‚ˆã€‚100ã‚’ ã‹ã‘ã‚Œã°ã„ã„ã‚“ã ã­ï¼' },
                { from: 'm', to: 'mm', m: 1000, expl: '1m ã¯ 1000mm ãªã‚“ã ã€‚ã¨ã£ã¦ã‚‚ãŸãã•ã‚“ã ã­ï¼' }
            ];
            const type = types[Math.floor(Math.random() * types.length)];
            const val = Math.floor(Math.random() * 9) + 1;
            elements.qContainer.innerHTML = `
                <div class="bg-orange-50 px-4 py-1 rounded-full text-orange-600 font-bold text-sm mb-4">ğŸ”„ ãŸã‚“ã„å¤‰æ›</div>
                <div class="text-3xl font-bold text-orange-600 px-2">${val}<span class="text-xl">${type.from}</span> ã¯ ãªã‚“${type.to}ï¼Ÿ</div>
            `;
            correctAnswer = (val * type.m) + type.to;
            currentExplanation = type.expl;
            setupOptions(correctAnswer);
        }

        function generateMeasure() {
            const lengthCm = (Math.floor(Math.random() * 120) + 10) / 10;
            const pxWidth = lengthCm * 30;
            elements.qContainer.innerHTML = `
                <div class="bg-purple-50 px-4 py-1 rounded-full text-purple-600 font-bold text-sm mb-4">ğŸ” ã‚‚ã®ã•ã—ã‚¯ã‚¤ã‚º</div>
                <div class="text-xl font-bold mb-4 text-purple-700">ã“ã®é’ã„æ£’ï¼ˆã¼ã†ï¼‰ã® ãªãŒã•ã¯ï¼Ÿ</div>
                <div class="relative w-full h-12 mb-4 bg-gray-50 rounded-full flex items-center px-1">
                    <div id="bar" class="bg-gradient-to-r from-blue-400 to-blue-600 h-6 rounded-full" style="width:0; transition:width 0.8s ease-out;"></div>
                </div>
                <div class="ruler rounded-xl border-2 border-yellow-400 overflow-hidden shadow-inner">${generateTicks()}</div>
            `;
            setTimeout(() => {
                const bar = document.getElementById('bar');
                if(bar) bar.style.width = pxWidth + 'px';
            }, 100);
            const cm = Math.floor(lengthCm);
            const mm = Math.round((lengthCm - cm) * 10);
            correctAnswer = (mm === 0) ? `${cm}cm` : `${cm}cm ${mm}mm`;
            currentExplanation = "ã‚‚ã®ã•ã—ã® å¤ªã„ç·šãŒ cmã€å°ã•ã„ç·šãŒ mm ã ã‚ˆã€‚ã‚ã‚‚ã‚Šã‚’ ã‚ˆãè¦‹ã¦ã¿ã‚ˆã†ï¼";
            setupOptions(correctAnswer);
        }

        function generateTicks() {
            let h = '';
            for(let i=0; i<=150; i++) {
                let cl = 'tick-mm';
                if(i % 10 === 0) cl = 'tick-cm';
                else if(i % 5 === 0) cl = 'tick-half';
                h += `<div class="tick ${cl}" style="left:${i*3}px"></div>`;
                if(i % 10 === 0) h += `<div class="absolute text-[10px] font-bold" style="left:${i*3-4}px;bottom:45px">${i/10}</div>`;
            }
            return h;
        }

        function setupOptions(correct) {
            let opts = [correct];
            while(opts.length < 4) {
                let val;
                if (activeMode === 'convert') {
                    val = (Math.floor(Math.random() * 100) * 10) + (correct.endsWith('cm') ? 'cm' : 'mm');
                } else {
                    const c = Math.floor(Math.random() * 20);
                    const m = Math.floor(Math.random() * 10);
                    const unit = correct.includes('m') && !correct.includes('cm') ? 'm' : (correct.includes('mm') ? 'mm' : 'cm');
                    if (correct.includes('m') && correct.includes('cm')) {
                        val = `${Math.floor(Math.random()*5)+1}m ${Math.floor(Math.random()*90)+5}cm`;
                    } else if (correct.includes('cm') && correct.includes('mm')) {
                        val = `${Math.floor(Math.random()*10)+1}cm ${Math.floor(Math.random()*9)+1}mm`;
                    } else {
                        val = c + unit;
                    }
                }
                if(val && !opts.includes(val)) opts.push(val);
            }
            opts.sort(() => Math.random() - 0.5).forEach(o => {
                const b = document.createElement('button');
                b.className = "bg-white border-4 border-gray-100 py-4 rounded-2xl text-xl font-bold shadow-md btn-bounce hover:border-pink-300 transition-colors";
                b.innerText = o;
                b.onclick = () => showResult(o === correct);
                elements.aContainer.appendChild(b);
            });
        }

        updateLevelUI();
    </script>
</body>
</html>

